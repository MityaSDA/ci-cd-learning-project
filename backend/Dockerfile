# =========================
# backend/Dockerfile
# =========================
# Используем официальный легковесный образ Python 3.10 (slim)
# Он меньше по размеру, чем полный python:3.10, и подходит для продакшена.
FROM python:3.10-slim

# -------------------------
# 1) Базовые настройки окружения Python
# -------------------------
# PYTHONDONTWRITEBYTECODE=1  -> не создаём .pyc файлы (меньше мусора в контейнере)
# PYTHONUNBUFFERED=1         -> вывод логов сразу в stdout/stderr (важно для логов Render)
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# -------------------------
# 2) Рабочая директория внутри контейнера
# -------------------------
# Все команды дальше выполняются из /app
WORKDIR /app

# -------------------------
# 3) Установка зависимостей (с кэшированием)
# -------------------------
# Сначала копируем только requirements.txt
# Это позволяет Docker кэшировать слой установки зависимостей:
# если requirements.txt не менялся, зависимости не будут устанавливаться заново.
COPY requirements.txt /app/requirements.txt

# Обновляем pip и устанавливаем зависимости
# --no-cache-dir экономит место (не хранит кэш пакетов внутри образа)
RUN pip install --upgrade pip && \
    pip install --no-cache-dir -r /app/requirements.txt

# -------------------------
# 4) Копируем код приложения
# -------------------------
# Важно: мы копируем только app.py (и при необходимости другие файлы)
# Это делает образ чище и предсказуемее.
# Если у тебя есть дополнительные модули, можно заменить на "COPY . /app"
COPY app.py /app/app.py

# -------------------------
# 5) Порт приложения
# -------------------------
# Render обычно пробрасывает порт автоматически,
# но EXPOSE полезен как документация и для локального запуска.
EXPOSE 10000

# -------------------------
# 6) Запуск приложения через Gunicorn
# -------------------------
# Почему Gunicorn:
# - продакшен WSGI-сервер (в отличие от встроенного flask run)
# - лучше управляет воркерами и стабильнее под нагрузкой
#
# Параметры:
# -b 0.0.0.0:10000        -> слушаем на всех интерфейсах (иначе Render не достучится)
# --workers 2             -> 2 воркера (для бесплатного/малого инстанса достаточно)
# --threads 4             -> потоки на воркер (под I/O задачи помогает)
# --timeout 60            -> чтобы долгий запрос не убивал воркер слишком рано
# --access-logfile -      -> логи доступа в stdout (видно в Render Logs)
# --error-logfile -       -> ошибки в stdout/stderr (видно в Render Logs)
#
# "app:app" означает:
# - файл app.py
# - переменная Flask-приложения внутри него app = Flask(...)
CMD ["gunicorn", "-b", "0.0.0.0:10000", "--workers", "2", "--threads", "4", "--timeout", "60", "--access-logfile", "-", "--error-logfile", "-", "app:app"]
