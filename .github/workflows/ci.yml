name: CI / Build Docker / Publish

on:
  push:
    branches: ["main"]
    tags:
      - "*"
  pull_request:
    branches: ["main"]

jobs:
  build-test-publish:
    runs-on: ubuntu-latest

    steps:
      # =========================================================
      # 1) Забираем код репозитория
      # =========================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================================================
      # 2) Ставим Python нужной версии
      # =========================================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # =========================================================
      # 3) Устанавливаем зависимости BACKEND
      # ---------------------------------------------------------
      # ВАЖНО:
      # - requirements.txt лежит в backend/requirements.txt
      # - pytest там НЕТ → ставим отдельно в CI
      # =========================================================
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      # =========================================================
      # 4) Запускаем тесты BACKEND
      # ---------------------------------------------------------
      # ❗❗ КРИТИЧЕСКИЙ МОМЕНТ ❗❗
      #
      # Ошибка "pytest: command not found" означает,
      # что pytest НЕ установлен.
      #
      # GitHub Actions НЕ ставит pytest автоматически.
      # Поэтому:
      #   1) ЯВНО ставим pytest
      #   2) Только потом запускаем тесты
      # =========================================================
      - name: Run backend tests
        run: |
          # Показываем версии (удобно для отладки)
          python --version
          pip --version

          # ЯВНО устанавливаем pytest
          pip install pytest

          # Запускаем тесты backend
          pytest backend/tests

      # =========================================================
      # 5) Логин в Docker Hub (нужно для push образа)
      # =========================================================
      - name: Login to Docker Hub
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # =========================================================
      # 6) Определяем тег образа (main -> latest, tag -> tagname)
      # =========================================================
      - name: Determine image tag
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        id: vars
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "TAG=latest" >> $GITHUB_OUTPUT
          fi

      # =========================================================
      # 7) Сборка Docker образа BACKEND
      # ---------------------------------------------------------
      # ВАЖНО:
      #   - Dockerfile лежит в backend/Dockerfile
      #   - Контекст сборки = backend
      # =========================================================
      - name: Build Docker image (backend)
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ steps.vars.outputs.TAG }} \
            -f backend/Dockerfile \
            backend

      # =========================================================
      # 8) Пуш образа в Docker Hub
      # =========================================================
      - name: Push Docker image
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ steps.vars.outputs.TAG }}

      # =========================================================
      # 9) Триггерим деплой в Render (после пуша образа)
      # =========================================================
      - name: Trigger Render Deploy
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        run: |
          echo "Triggering Render deploy..."
          curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
