name: Python CI

# ====================================================================
#  Настройки событий: запускаем CI при push и pull_request в main
# ====================================================================
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest   # GitHub Actions использует Ubuntu VM

    steps:

      # ==============================================================
      # 1. Клонируем репозиторий внутрь runner
      # ==============================================================
      - name: Checkout repository
        uses: actions/checkout@v3

      # ==============================================================
      # 2. Устанавливаем Python 3.10
      # ==============================================================
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # ==============================================================
      # 3. Ставим зависимости
      # ==============================================================
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ==============================================================
      # 4. Запускаем тесты
      # ==============================================================
      - name: Run tests
        run: pytest

      # ==============================================================
      # 5. Генерируем теги для Docker образа
      #    SHA_TAG — первые 7 символов хэша коммита
      #    DATE_TAG — текущая дата в формате 20250101
      # ==============================================================
      - name: Set image tags
        id: vars
        run: |
          echo "SHA_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "DATE_TAG=$(date +'%Y%m%d')" >> $GITHUB_ENV

      # ==============================================================
      # 6. Включаем Docker Buildx (улучшенный docker build)
      # ==============================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # ==============================================================
      # 7. Сборка Docker-образа с тремя тегами:
      #    latest, SHA_TAG, DATE_TAG
      # ==============================================================
      - name: Build Docker image
        run: |
          docker build \
            -t myapp:latest \
            -t myapp:${{ env.SHA_TAG }} \
            -t myapp:${{ env.DATE_TAG }} \
            .

      # ==============================================================
      # 8. Логин в Docker Hub (через GitHub Secrets)
      # ==============================================================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ==============================================================
      # 9. Публикация всех трёх Docker тегов в Docker Hub
      # ==============================================================
      - name: Push Docker image
        run: |
          # Настраиваем теги для Docker Hub
          docker tag myapp:latest ${{ secrets.DOCKERHUB_USERNAME }}/myapp:latest
          docker tag myapp:${{ env.SHA_TAG }} ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ env.SHA_TAG }}
          docker tag myapp:${{ env.DATE_TAG }} ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ env.DATE_TAG }}

          # Отправляем образы
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/myapp:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ env.SHA_TAG }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ env.DATE_TAG }}
