"""
test_app.py — тесты для API сервиса (middle level)

Мы тестируем API через HTTP-клиент Flask: client.get("/api/add?a=2&b=3")
"""

import pytest
from app import app  # импортируем Flask-приложение


# ------------------------------------------------------------------------------
# Фикстура создает тестовый клиент Flask
# ------------------------------------------------------------------------------
@pytest.fixture
def client():
    """
    Создаёт тестовый HTTP-клиент, который позволяет выполнять запросы
    без запуска настоящего сервера.
    """
    app.testing = True
    return app.test_client()


# ------------------------------------------------------------------------------
# Тест сложения
# ------------------------------------------------------------------------------
def test_add(client):
    """
    Проверяет эндпоинт /api/add
    """
    response = client.get("/api/add?a=2&b=3")

    # Проверяем, что сервер вернул 200 OK
    assert response.status_code == 200

    # Проверяем правильность результата
    assert response.get_json()["result"] == 5


# ------------------------------------------------------------------------------
# Тест умножения
# ------------------------------------------------------------------------------
def test_multiply(client):
    response = client.get("/api/multiply?a=4&b=5")
    assert response.status_code == 200
    assert response.get_json()["result"] == 20


# ------------------------------------------------------------------------------
# Тест деления
# ------------------------------------------------------------------------------
def test_divide(client):
    response = client.get("/api/divide?a=10&b=2")
    assert response.status_code == 200
    assert response.get_json()["result"] == 5


# ------------------------------------------------------------------------------
# Тест деления на ноль
# ------------------------------------------------------------------------------
def test_divide_by_zero(client):
    response = client.get("/api/divide?a=10&b=0")
    assert response.status_code == 400
    assert "error" in response.get_json()
